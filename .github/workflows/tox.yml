---
name: tox

on:
  pull_request:
    branches:
      - main

  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  tox:
    name: ${{ matrix.toxenv }}

    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        toxenv:
          - lint
          - podman
          - docker

    env:
      TOXENV: ${{ matrix.toxenv }}
      EXTRA_OPTS: --platform linux/amd64,linux/arm64

    steps:
      - name: Grab the source from Git
        uses: actions/checkout@v2

      - uses: actions/setup-python@v2
        with:
          # keep this in sync with python version from base container
          python-version: "3.10" # 3.10 is default on ubuntu-22.04

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get -qq install -y --no-install-recommends --no-install-suggests -o=Dpkg::Use-Pty=0 qemu-user-static
          python -m pip install tox

      - name: Prepare ${{ env.TOXENV }} tox testenv
        run: tox --skip-missing-interpreters false --notest

      - name: Run ${{ env.TOXENV }} tox testenv
        run: tox --skip-missing-interpreters false

  check: # This job does nothing and is only used for the branch protection
    if: always()

    needs:
      - tox

    runs-on: ubuntu-latest

    steps:
      - name: Decide whether the needed jobs succeeded or failed
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
